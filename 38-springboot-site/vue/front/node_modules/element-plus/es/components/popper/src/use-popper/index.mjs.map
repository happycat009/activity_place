{"version":3,"file":"index.mjs","sources":["../../../../../../../packages/components/popper/src/use-popper/index.ts"],"sourcesContent":["import { computed, ref, reactive, watch, unref } from 'vue'\nimport { createPopper } from '@popperjs/core'\nimport {\n  generateId,\n  isBool,\n  isHTMLElement,\n  isArray,\n  isString,\n} from '@element-plus/utils/util'\nimport { PopupManager } from '@element-plus/utils/popup-manager'\nimport usePopperOptions from './popper-options'\n\nimport type {\n  ComponentPublicInstance,\n  CSSProperties,\n  SetupContext,\n  Ref,\n} from 'vue'\nimport type { TimeoutHandle, Nullable } from '@element-plus/utils/types'\nimport type {\n  IPopperOptions,\n  TriggerType,\n  PopperInstance,\n  RefElement,\n} from './defaults'\n\nexport type ElementType = ComponentPublicInstance | HTMLElement\nexport type EmitType =\n  | 'update:visible'\n  | 'after-enter'\n  | 'after-leave'\n  | 'before-enter'\n  | 'before-leave'\n\nexport interface PopperEvents {\n  onClick?: (e: Event) => void\n  onMouseenter?: (e: Event) => void\n  onMouseleave?: (e: Event) => void\n  onFocus?: (e: Event) => void\n  onBlur?: (e: Event) => void\n}\n\nexport const DEFAULT_TRIGGER = ['hover']\nexport const UPDATE_VISIBLE_EVENT = 'update:visible'\nexport default function (\n  props: IPopperOptions,\n  { emit }: SetupContext<EmitType[]>\n) {\n  const arrowRef = ref<RefElement>(null)\n  const triggerRef = ref(null) as Ref<ElementType>\n  const popperRef = ref<RefElement>(null)\n\n  const popperId = `el-popper-${generateId()}`\n  let popperInstance: Nullable<PopperInstance> = null\n  let showTimer: Nullable<TimeoutHandle> = null\n  let hideTimer: Nullable<TimeoutHandle> = null\n  let triggerFocused = false\n\n  const isManualMode = () => props.manualMode || props.trigger === 'manual'\n\n  const popperStyle = ref<CSSProperties>({ zIndex: PopupManager.nextZIndex() })\n\n  const popperOptions = usePopperOptions(props, {\n    arrow: arrowRef,\n  })\n\n  const state = reactive({\n    visible: !!props.visible,\n  })\n  // visible has been taken by props.visible, avoiding name collision\n  // Either marking type here or setter parameter\n  const visibility = computed<boolean>({\n    get() {\n      if (props.disabled) {\n        return false\n      } else {\n        return isBool(props.visible) ? props.visible : state.visible\n      }\n    },\n    set(val) {\n      if (isManualMode()) return\n      isBool(props.visible)\n        ? emit(UPDATE_VISIBLE_EVENT, val)\n        : (state.visible = val)\n    },\n  })\n\n  function _show() {\n    if (props.autoClose > 0) {\n      hideTimer = window.setTimeout(() => {\n        _hide()\n      }, props.autoClose)\n    }\n    visibility.value = true\n  }\n\n  function _hide() {\n    visibility.value = false\n  }\n\n  function clearTimers() {\n    clearTimeout(showTimer)\n    clearTimeout(hideTimer)\n  }\n\n  const show = () => {\n    if (isManualMode() || props.disabled) return\n    clearTimers()\n    if (props.showAfter === 0) {\n      _show()\n    } else {\n      showTimer = window.setTimeout(() => {\n        _show()\n      }, props.showAfter)\n    }\n  }\n\n  const hide = () => {\n    if (isManualMode()) return\n    clearTimers()\n    if (props.hideAfter > 0) {\n      hideTimer = window.setTimeout(() => {\n        close()\n      }, props.hideAfter)\n    } else {\n      close()\n    }\n  }\n  const close = () => {\n    _hide()\n    if (props.disabled) {\n      doDestroy(true)\n    }\n  }\n\n  function onPopperMouseEnter() {\n    // if trigger is click, user won't be able to close popper when\n    // user tries to move the mouse over popper contents\n    if (props.enterable && props.trigger !== 'click') {\n      clearTimeout(hideTimer)\n    }\n  }\n\n  function onPopperMouseLeave() {\n    const { trigger } = props\n    const shouldPrevent =\n      (isString(trigger) && (trigger === 'click' || trigger === 'focus')) ||\n      // we'd like to test array type trigger here, but the only case we need to cover is trigger === 'click' or\n      // trigger === 'focus', because that when trigger is string\n      // trigger.length === 1 and trigger[0] === 5 chars string is mutually exclusive.\n      // so there will be no need to test if trigger is array type.\n      (trigger.length === 1 &&\n        (trigger[0] === 'click' || trigger[0] === 'focus'))\n\n    if (shouldPrevent) return\n\n    hide()\n  }\n\n  function initializePopper() {\n    if (!unref(visibility)) {\n      return\n    }\n    const unwrappedTrigger = unref(triggerRef)\n    const _trigger = isHTMLElement(unwrappedTrigger)\n      ? unwrappedTrigger\n      : (unwrappedTrigger as ComponentPublicInstance).$el\n    popperInstance = createPopper(\n      _trigger,\n      unref(popperRef),\n      unref(popperOptions)\n    )\n\n    popperInstance.update()\n  }\n\n  function doDestroy(forceDestroy?: boolean) {\n    /* istanbul ignore if */\n    if (!popperInstance || (unref(visibility) && !forceDestroy)) return\n    detachPopper()\n  }\n\n  function detachPopper() {\n    popperInstance?.destroy?.()\n    popperInstance = null\n  }\n\n  const events = {} as PopperEvents\n\n  function update() {\n    if (!unref(visibility)) {\n      return\n    }\n    if (popperInstance) {\n      popperInstance.update()\n    } else {\n      initializePopper()\n    }\n  }\n\n  function onVisibilityChange(toState: boolean) {\n    if (toState) {\n      popperStyle.value.zIndex = PopupManager.nextZIndex()\n      if (popperInstance) {\n        popperInstance.update()\n      } else {\n        initializePopper()\n      }\n    }\n  }\n\n  if (!isManualMode()) {\n    const toggleState = () => {\n      if (unref(visibility)) {\n        hide()\n      } else {\n        show()\n      }\n    }\n\n    const popperEventsHandler = (e: Event) => {\n      e.stopPropagation()\n      switch (e.type) {\n        case 'click': {\n          if (triggerFocused) {\n            // reset previous focus event\n            triggerFocused = false\n          } else {\n            toggleState()\n          }\n          break\n        }\n        case 'mouseenter': {\n          show()\n          break\n        }\n        case 'mouseleave': {\n          hide()\n          break\n        }\n        case 'focus': {\n          triggerFocused = true\n          show()\n          break\n        }\n        case 'blur': {\n          triggerFocused = false\n          hide()\n          break\n        }\n      }\n    }\n\n    const triggerEventsMap: Partial<\n      Record<TriggerType, (keyof PopperEvents)[]>\n    > = {\n      click: ['onClick'],\n      hover: ['onMouseenter', 'onMouseleave'],\n      focus: ['onFocus', 'onBlur'],\n    }\n\n    const mapEvents = (t: TriggerType) => {\n      triggerEventsMap[t].forEach((event) => {\n        events[event] = popperEventsHandler\n      })\n    }\n\n    if (isArray(props.trigger)) {\n      Object.values(props.trigger).forEach(mapEvents)\n    } else {\n      mapEvents(props.trigger as TriggerType)\n    }\n  }\n\n  watch(popperOptions, (val) => {\n    if (!popperInstance) return\n    popperInstance.setOptions(val)\n    popperInstance.update()\n  })\n\n  watch(visibility, onVisibilityChange)\n\n  return {\n    update,\n    doDestroy,\n    show,\n    hide,\n    onPopperMouseEnter,\n    onPopperMouseLeave,\n    onAfterEnter: () => {\n      emit('after-enter')\n    },\n    onAfterLeave: () => {\n      detachPopper()\n      emit('after-leave')\n    },\n    onBeforeEnter: () => {\n      emit('before-enter')\n    },\n    onBeforeLeave: () => {\n      emit('before-leave')\n    },\n    initializePopper,\n    isManualMode,\n    arrowRef,\n    events,\n    popperId,\n    popperInstance,\n    popperRef,\n    popperStyle,\n    triggerRef,\n    visibility,\n  }\n}\n\nexport * from './defaults'\n"],"names":[],"mappings":";;;;;;;;AAWY,MAAC,eAAe,GAAG,CAAC,OAAO,EAAE;AAC7B,MAAC,oBAAoB,GAAG,iBAAiB;AACtC,kBAAQ,CAAC,KAAK,EAAE,EAAE,IAAI,EAAE,EAAE;AACzC,EAAE,MAAM,QAAQ,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC;AAC7B,EAAE,MAAM,UAAU,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC;AAC/B,EAAE,MAAM,SAAS,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC;AAC9B,EAAE,MAAM,QAAQ,GAAG,CAAC,UAAU,EAAE,UAAU,EAAE,CAAC,CAAC,CAAC;AAC/C,EAAE,IAAI,cAAc,GAAG,IAAI,CAAC;AAC5B,EAAE,IAAI,SAAS,GAAG,IAAI,CAAC;AACvB,EAAE,IAAI,SAAS,GAAG,IAAI,CAAC;AACvB,EAAE,IAAI,cAAc,GAAG,KAAK,CAAC;AAC7B,EAAE,MAAM,YAAY,GAAG,MAAM,KAAK,CAAC,UAAU,IAAI,KAAK,CAAC,OAAO,KAAK,QAAQ,CAAC;AAC5E,EAAE,MAAM,WAAW,GAAG,GAAG,CAAC,EAAE,MAAM,EAAE,YAAY,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;AACjE,EAAE,MAAM,aAAa,GAAG,gBAAgB,CAAC,KAAK,EAAE;AAChD,IAAI,KAAK,EAAE,QAAQ;AACnB,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,KAAK,GAAG,QAAQ,CAAC;AACzB,IAAI,OAAO,EAAE,CAAC,CAAC,KAAK,CAAC,OAAO;AAC5B,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,UAAU,GAAG,QAAQ,CAAC;AAC9B,IAAI,GAAG,GAAG;AACV,MAAM,IAAI,KAAK,CAAC,QAAQ,EAAE;AAC1B,QAAQ,OAAO,KAAK,CAAC;AACrB,OAAO,MAAM;AACb,QAAQ,OAAO,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,KAAK,CAAC,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC;AACrE,OAAO;AACP,KAAK;AACL,IAAI,GAAG,CAAC,GAAG,EAAE;AACb,MAAM,IAAI,YAAY,EAAE;AACxB,QAAQ,OAAO;AACf,MAAM,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,oBAAoB,EAAE,GAAG,CAAC,GAAG,KAAK,CAAC,OAAO,GAAG,GAAG,CAAC;AACpF,KAAK;AACL,GAAG,CAAC,CAAC;AACL,EAAE,SAAS,KAAK,GAAG;AACnB,IAAI,IAAI,KAAK,CAAC,SAAS,GAAG,CAAC,EAAE;AAC7B,MAAM,SAAS,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM;AAC1C,QAAQ,KAAK,EAAE,CAAC;AAChB,OAAO,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;AAC1B,KAAK;AACL,IAAI,UAAU,CAAC,KAAK,GAAG,IAAI,CAAC;AAC5B,GAAG;AACH,EAAE,SAAS,KAAK,GAAG;AACnB,IAAI,UAAU,CAAC,KAAK,GAAG,KAAK,CAAC;AAC7B,GAAG;AACH,EAAE,SAAS,WAAW,GAAG;AACzB,IAAI,YAAY,CAAC,SAAS,CAAC,CAAC;AAC5B,IAAI,YAAY,CAAC,SAAS,CAAC,CAAC;AAC5B,GAAG;AACH,EAAE,MAAM,IAAI,GAAG,MAAM;AACrB,IAAI,IAAI,YAAY,EAAE,IAAI,KAAK,CAAC,QAAQ;AACxC,MAAM,OAAO;AACb,IAAI,WAAW,EAAE,CAAC;AAClB,IAAI,IAAI,KAAK,CAAC,SAAS,KAAK,CAAC,EAAE;AAC/B,MAAM,KAAK,EAAE,CAAC;AACd,KAAK,MAAM;AACX,MAAM,SAAS,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM;AAC1C,QAAQ,KAAK,EAAE,CAAC;AAChB,OAAO,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;AAC1B,KAAK;AACL,GAAG,CAAC;AACJ,EAAE,MAAM,IAAI,GAAG,MAAM;AACrB,IAAI,IAAI,YAAY,EAAE;AACtB,MAAM,OAAO;AACb,IAAI,WAAW,EAAE,CAAC;AAClB,IAAI,IAAI,KAAK,CAAC,SAAS,GAAG,CAAC,EAAE;AAC7B,MAAM,SAAS,GAAG,MAAM,CAAC,UAAU,CAAC,MAAM;AAC1C,QAAQ,KAAK,EAAE,CAAC;AAChB,OAAO,EAAE,KAAK,CAAC,SAAS,CAAC,CAAC;AAC1B,KAAK,MAAM;AACX,MAAM,KAAK,EAAE,CAAC;AACd,KAAK;AACL,GAAG,CAAC;AACJ,EAAE,MAAM,KAAK,GAAG,MAAM;AACtB,IAAI,KAAK,EAAE,CAAC;AACZ,IAAI,IAAI,KAAK,CAAC,QAAQ,EAAE;AACxB,MAAM,SAAS,CAAC,IAAI,CAAC,CAAC;AACtB,KAAK;AACL,GAAG,CAAC;AACJ,EAAE,SAAS,kBAAkB,GAAG;AAChC,IAAI,IAAI,KAAK,CAAC,SAAS,IAAI,KAAK,CAAC,OAAO,KAAK,OAAO,EAAE;AACtD,MAAM,YAAY,CAAC,SAAS,CAAC,CAAC;AAC9B,KAAK;AACL,GAAG;AACH,EAAE,SAAS,kBAAkB,GAAG;AAChC,IAAI,MAAM,EAAE,OAAO,EAAE,GAAG,KAAK,CAAC;AAC9B,IAAI,MAAM,aAAa,GAAG,QAAQ,CAAC,OAAO,CAAC,KAAK,OAAO,KAAK,OAAO,IAAI,OAAO,KAAK,OAAO,CAAC,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,KAAK,OAAO,CAAC,CAAC,CAAC,KAAK,OAAO,IAAI,OAAO,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,CAAC;AAC1K,IAAI,IAAI,aAAa;AACrB,MAAM,OAAO;AACb,IAAI,IAAI,EAAE,CAAC;AACX,GAAG;AACH,EAAE,SAAS,gBAAgB,GAAG;AAC9B,IAAI,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,EAAE;AAC5B,MAAM,OAAO;AACb,KAAK;AACL,IAAI,MAAM,gBAAgB,GAAG,KAAK,CAAC,UAAU,CAAC,CAAC;AAC/C,IAAI,MAAM,QAAQ,GAAG,aAAa,CAAC,gBAAgB,CAAC,GAAG,gBAAgB,GAAG,gBAAgB,CAAC,GAAG,CAAC;AAC/F,IAAI,cAAc,GAAG,YAAY,CAAC,QAAQ,EAAE,KAAK,CAAC,SAAS,CAAC,EAAE,KAAK,CAAC,aAAa,CAAC,CAAC,CAAC;AACpF,IAAI,cAAc,CAAC,MAAM,EAAE,CAAC;AAC5B,GAAG;AACH,EAAE,SAAS,SAAS,CAAC,YAAY,EAAE;AACnC,IAAI,IAAI,CAAC,cAAc,IAAI,KAAK,CAAC,UAAU,CAAC,IAAI,CAAC,YAAY;AAC7D,MAAM,OAAO;AACb,IAAI,YAAY,EAAE,CAAC;AACnB,GAAG;AACH,EAAE,SAAS,YAAY,GAAG;AAC1B,IAAI,IAAI,EAAE,CAAC;AACX,IAAI,CAAC,EAAE,GAAG,cAAc,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,cAAc,CAAC,OAAO,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;AAC/G,IAAI,cAAc,GAAG,IAAI,CAAC;AAC1B,GAAG;AACH,EAAE,MAAM,MAAM,GAAG,EAAE,CAAC;AACpB,EAAE,SAAS,MAAM,GAAG;AACpB,IAAI,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,EAAE;AAC5B,MAAM,OAAO;AACb,KAAK;AACL,IAAI,IAAI,cAAc,EAAE;AACxB,MAAM,cAAc,CAAC,MAAM,EAAE,CAAC;AAC9B,KAAK,MAAM;AACX,MAAM,gBAAgB,EAAE,CAAC;AACzB,KAAK;AACL,GAAG;AACH,EAAE,SAAS,kBAAkB,CAAC,OAAO,EAAE;AACvC,IAAI,IAAI,OAAO,EAAE;AACjB,MAAM,WAAW,CAAC,KAAK,CAAC,MAAM,GAAG,YAAY,CAAC,UAAU,EAAE,CAAC;AAC3D,MAAM,IAAI,cAAc,EAAE;AAC1B,QAAQ,cAAc,CAAC,MAAM,EAAE,CAAC;AAChC,OAAO,MAAM;AACb,QAAQ,gBAAgB,EAAE,CAAC;AAC3B,OAAO;AACP,KAAK;AACL,GAAG;AACH,EAAE,IAAI,CAAC,YAAY,EAAE,EAAE;AACvB,IAAI,MAAM,WAAW,GAAG,MAAM;AAC9B,MAAM,IAAI,KAAK,CAAC,UAAU,CAAC,EAAE;AAC7B,QAAQ,IAAI,EAAE,CAAC;AACf,OAAO,MAAM;AACb,QAAQ,IAAI,EAAE,CAAC;AACf,OAAO;AACP,KAAK,CAAC;AACN,IAAI,MAAM,mBAAmB,GAAG,CAAC,CAAC,KAAK;AACvC,MAAM,CAAC,CAAC,eAAe,EAAE,CAAC;AAC1B,MAAM,QAAQ,CAAC,CAAC,IAAI;AACpB,QAAQ,KAAK,OAAO,EAAE;AACtB,UAAU,IAAI,cAAc,EAAE;AAC9B,YAAY,cAAc,GAAG,KAAK,CAAC;AACnC,WAAW,MAAM;AACjB,YAAY,WAAW,EAAE,CAAC;AAC1B,WAAW;AACX,UAAU,MAAM;AAChB,SAAS;AACT,QAAQ,KAAK,YAAY,EAAE;AAC3B,UAAU,IAAI,EAAE,CAAC;AACjB,UAAU,MAAM;AAChB,SAAS;AACT,QAAQ,KAAK,YAAY,EAAE;AAC3B,UAAU,IAAI,EAAE,CAAC;AACjB,UAAU,MAAM;AAChB,SAAS;AACT,QAAQ,KAAK,OAAO,EAAE;AACtB,UAAU,cAAc,GAAG,IAAI,CAAC;AAChC,UAAU,IAAI,EAAE,CAAC;AACjB,UAAU,MAAM;AAChB,SAAS;AACT,QAAQ,KAAK,MAAM,EAAE;AACrB,UAAU,cAAc,GAAG,KAAK,CAAC;AACjC,UAAU,IAAI,EAAE,CAAC;AACjB,UAAU,MAAM;AAChB,SAAS;AACT,OAAO;AACP,KAAK,CAAC;AACN,IAAI,MAAM,gBAAgB,GAAG;AAC7B,MAAM,KAAK,EAAE,CAAC,SAAS,CAAC;AACxB,MAAM,KAAK,EAAE,CAAC,cAAc,EAAE,cAAc,CAAC;AAC7C,MAAM,KAAK,EAAE,CAAC,SAAS,EAAE,QAAQ,CAAC;AAClC,KAAK,CAAC;AACN,IAAI,MAAM,SAAS,GAAG,CAAC,CAAC,KAAK;AAC7B,MAAM,gBAAgB,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,KAAK,KAAK;AAC7C,QAAQ,MAAM,CAAC,KAAK,CAAC,GAAG,mBAAmB,CAAC;AAC5C,OAAO,CAAC,CAAC;AACT,KAAK,CAAC;AACN,IAAI,IAAI,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,EAAE;AAChC,MAAM,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC;AACtD,KAAK,MAAM;AACX,MAAM,SAAS,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;AAC/B,KAAK;AACL,GAAG;AACH,EAAE,KAAK,CAAC,aAAa,EAAE,CAAC,GAAG,KAAK;AAChC,IAAI,IAAI,CAAC,cAAc;AACvB,MAAM,OAAO;AACb,IAAI,cAAc,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;AACnC,IAAI,cAAc,CAAC,MAAM,EAAE,CAAC;AAC5B,GAAG,CAAC,CAAC;AACL,EAAE,KAAK,CAAC,UAAU,EAAE,kBAAkB,CAAC,CAAC;AACxC,EAAE,OAAO;AACT,IAAI,MAAM;AACV,IAAI,SAAS;AACb,IAAI,IAAI;AACR,IAAI,IAAI;AACR,IAAI,kBAAkB;AACtB,IAAI,kBAAkB;AACtB,IAAI,YAAY,EAAE,MAAM;AACxB,MAAM,IAAI,CAAC,aAAa,CAAC,CAAC;AAC1B,KAAK;AACL,IAAI,YAAY,EAAE,MAAM;AACxB,MAAM,YAAY,EAAE,CAAC;AACrB,MAAM,IAAI,CAAC,aAAa,CAAC,CAAC;AAC1B,KAAK;AACL,IAAI,aAAa,EAAE,MAAM;AACzB,MAAM,IAAI,CAAC,cAAc,CAAC,CAAC;AAC3B,KAAK;AACL,IAAI,aAAa,EAAE,MAAM;AACzB,MAAM,IAAI,CAAC,cAAc,CAAC,CAAC;AAC3B,KAAK;AACL,IAAI,gBAAgB;AACpB,IAAI,YAAY;AAChB,IAAI,QAAQ;AACZ,IAAI,MAAM;AACV,IAAI,QAAQ;AACZ,IAAI,cAAc;AAClB,IAAI,SAAS;AACb,IAAI,WAAW;AACf,IAAI,UAAU;AACd,IAAI,UAAU;AACd,GAAG,CAAC;AACJ;;;;"}